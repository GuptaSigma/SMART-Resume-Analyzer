<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartHire.AI - Analysis Results</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa',
                            500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a', 950: '#172554',
                        },
                    },
                },
            },
        }
    </script>
    <style>
        .score-excellent { @apply bg-green-600 text-white shadow-lg shadow-green-200; }
        .score-good { @apply bg-blue-500 text-white shadow-lg shadow-blue-200; }
        .score-average { @apply bg-amber-500 text-white shadow-lg shadow-amber-200; }
        .score-poor { @apply bg-red-600 text-white shadow-lg shadow-red-200; }
        
        .hr-skill-highlight {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            @apply border-2 border-green-500 text-green-900 font-bold;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen">

<nav class="bg-primary-600 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
            <a class="flex items-center space-x-2 text-xl font-bold" href="/">
                <i class="fas fa-brain"></i>
                <span>SmartHire.AI</span>
            </a>
            <div class="flex space-x-6">
                <a class="hover:text-blue-200 transition-colors flex items-center text-sm font-medium" href="/">
                    <i class="fas fa-arrow-left mr-2"></i>New Analysis
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="toast-container fixed top-5 right-5 z-[9999] flex flex-col gap-3"></div>

<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header Section -->
    <div class="bg-white rounded-3xl p-8 mb-8 border border-slate-200 shadow-sm overflow-hidden relative">
        <div class="absolute top-0 right-0 w-64 h-64 bg-primary-50 rounded-full -mr-32 -mt-32 opacity-50"></div>
        <div class="relative flex flex-col md:flex-row justify-between items-center gap-8">
            <div class="text-center md:text-left">
                <div class="inline-flex items-center px-3 py-1 bg-primary-100 text-primary-700 rounded-full text-xs font-bold mb-4">
                    <i class="fas fa-check-circle mr-2"></i>ANALYSIS COMPLETE
                </div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tight">
                    Results for <span class="text-primary-600">{{ company_name }}</span>
                </h1>
                <p class="text-slate-500 mt-2 text-lg font-medium flex items-center justify-center md:justify-start">
                    <i class="fas fa-user-tie mr-2 text-slate-400"></i>Analyzed by {{ hr_name }}
                </p>
            </div>
            <div class="flex flex-wrap justify-center gap-4">
                {% if shortlisted or not_selected %}
                <a href="{{ url_for('download_report', company_name=company_name) }}" class="inline-flex items-center px-6 py-3.5 bg-green-600 text-white rounded-2xl font-bold hover:bg-green-700 transition-all shadow-lg hover:shadow-green-200 active:scale-95">
                    <i class="fas fa-file-export mr-2"></i>Export CSV
                </a>
                <a href="{{ url_for('download_all_selected', company_name=company_name) }}" class="inline-flex items-center px-6 py-3.5 bg-primary-600 text-white rounded-2xl font-bold hover:bg-primary-700 transition-all shadow-lg hover:shadow-primary-200 active:scale-95">
                    <i class="fas fa-layer-group mr-2"></i>Batch Selection
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 group hover:border-primary-400 transition-all">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-slate-50 text-slate-600 rounded-xl flex items-center justify-center group-hover:bg-primary-50 group-hover:text-primary-600 transition-colors">
                    <i class="fas fa-file-alt text-xl"></i>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total</span>
            </div>
            <h3 class="text-3xl font-black text-slate-900">{{ total_processed }}</h3>
            <p class="text-slate-500 text-sm font-medium mt-1">Resumes Analyzed</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 group hover:border-green-400 transition-all">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-star text-xl"></i>
                </div>
                <span class="text-xs font-bold text-green-500 uppercase tracking-widest">Shortlist</span>
            </div>
            <h3 class="text-3xl font-black text-slate-900">{{ shortlisted|length }}</h3>
            <p class="text-slate-500 text-sm font-medium mt-1">Met Criteria</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 group hover:border-red-400 transition-all">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-red-50 text-red-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-times-circle text-xl"></i>
                </div>
                <span class="text-xs font-bold text-red-500 uppercase tracking-widest">Rejected</span>
            </div>
            <h3 class="text-3xl font-black text-slate-900">{{ not_selected|length }}</h3>
            <p class="text-slate-500 text-sm font-medium mt-1">Below Threshold</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 group hover:border-amber-400 transition-all">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-robot text-xl"></i>
                </div>
                <span class="text-xs font-bold text-amber-500 uppercase tracking-widest">AI Audit</span>
            </div>
            <h3 class="text-3xl font-black text-slate-900">{{ (shortlisted + not_selected)|selectattr('is_ai_generated')|list|length }}</h3>
            <p class="text-slate-500 text-sm font-medium mt-1">AI Detected</p>
        </div>
    </div>

    <!-- Shortlisted Candidates -->
    {% if shortlisted %}
    <div class="mb-16 animate-fade-in">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center space-x-4">
                <div class="w-2 h-10 bg-green-500 rounded-full"></div>
                <div>
                    <h2 class="text-3xl font-black text-slate-900">Shortlisted Talent</h2>
                    <p class="text-slate-500 font-medium">Top performing candidates for your role</p>
                </div>
            </div>
            <button onclick="sendAllCongratulations()" class="inline-flex items-center px-6 py-3 bg-white border-2 border-green-600 text-green-700 rounded-2xl font-black hover:bg-green-50 transition-all group active:scale-95 shadow-lg shadow-green-100/20">
                <i class="fas fa-paper-plane mr-2 group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
                Email All Selected
            </button>
        </div>

        <div class="grid lg:grid-cols-2 gap-8">
            {% for candidate in shortlisted %}
            <div class="bg-white rounded-3xl border border-slate-200 shadow-sm hover:shadow-xl hover:border-primary-200 transition-all group shortlisted-card overflow-hidden">
                <div class="p-8">
                    <!-- Card Top -->
                    <div class="flex justify-between items-start mb-8">
                        <div class="space-y-3 flex-1 overflow-hidden">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-primary-100 text-primary-600 rounded-2xl flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-user text-xl"></i>
                                </div>
                                <div class="overflow-hidden">
                                    <h3 class="text-2xl font-black text-slate-900 truncate">{{ candidate.name }}</h3>
                                    <p class="text-sm font-bold text-slate-400 flex items-center italic truncate">
                                        <i class="fas fa-file-pdf mr-2 text-primary-400"></i>{{ candidate.resume_filename }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-3 ml-4">
                            <div class="w-20 h-20 rounded-2xl flex flex-col items-center justify-center text-center shadow-lg transition-transform group-hover:scale-110 {% if candidate.match_score >= 90 %}score-excellent{% elif candidate.match_score >= 80 %}score-good{% else %}score-average{% endif %}">
                                <span class="text-2xl font-black leading-none">{{ candidate.match_score }}%</span>
                                <span class="text-[10px] uppercase font-bold mt-1 opacity-80 tracking-tighter">Match</span>
                            </div>
                            {% if candidate.is_ai_generated %}
                            <button onclick="checkAI('{{ candidate.resume_filename }}')" class="px-3 py-1.5 bg-amber-50 text-amber-600 text-[10px] font-black rounded-xl border border-amber-200 flex items-center hover:bg-amber-100 transition-colors">
                                <i class="fas fa-robot mr-1.5 animate-pulse"></i>AI CONTENT FLAG
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- HR Flags -->
                    {% if candidate.hr_flags and candidate.hr_flags|length > 0 %}
                    <div class="bg-amber-50 border-2 border-amber-200 rounded-2xl p-4 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <i class="fas fa-exclamation-triangle text-4xl"></i>
                        </div>
                        <h6 class="text-amber-900 font-black mb-2 flex items-center text-xs uppercase tracking-widest">
                            <i class="fas fa-info-circle mr-2"></i>HR Filter Alerts
                        </h6>
                        <ul class="space-y-1 relative z-10">
                            {% for flag in candidate.hr_flags %}
                            <li class="text-amber-800 text-sm font-bold flex items-start">
                                <span class="text-amber-400 mr-2">â€¢</span>{{ flag }}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    <!-- Key Details Grid -->
                    <div class="grid grid-cols-2 gap-6 mb-8 bg-slate-50 border border-slate-100 rounded-2xl p-6">
                        <div class="space-y-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Experience</span>
                            <div class="flex items-center text-slate-700 font-bold">
                                <i class="fas fa-briefcase mr-2 text-primary-500"></i>{{ candidate.experience }}
                            </div>
                        </div>
                        <div class="space-y-1">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Target Role</span>
                            <div class="flex items-center">
                                <span class="bg-primary-600 text-white text-[10px] font-black px-2 py-1 rounded-md">{{ candidate.target_role }}</span>
                            </div>
                        </div>
                        <div class="space-y-1 col-span-2 border-t border-slate-200 pt-4">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Contact Information</span>
                            <div class="flex flex-wrap gap-x-6 gap-y-2 mt-2">
                                <a href="mailto:{{ candidate.email }}" class="text-sm font-bold text-slate-600 hover:text-primary-600 transition-colors flex items-center candidate-email-placeholder">
                                    <i class="fas fa-envelope mr-2 text-primary-400 w-4"></i>{{ candidate.email or 'N/A' }}
                                </a>
                                <div class="text-sm font-bold text-slate-600 flex items-center">
                                    <i class="fas fa-phone mr-2 text-primary-400 w-4"></i>{{ candidate.phone or 'N/A' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Matrix -->
                    <div class="mb-8">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center">
                            <i class="fas fa-bolt mr-2 text-primary-600"></i>Requirement Matrix
                        </h4>
                        <div class="flex flex-wrap gap-2.5">
                            {% for s in candidate.skills %}
                            <div class="inline-flex items-center px-4 py-2 rounded-2xl text-xs font-bold transition-all border-2 {% if s.is_hr_requirement %}hr-skill-highlight{% elif s.match %}bg-emerald-50 text-emerald-700 border-emerald-200{% else %}bg-slate-50 text-slate-400 border-slate-100{% endif %}">
                                <i class="fas {{ 'fa-check-circle text-emerald-500' if s.match else 'fa-times-circle' }} mr-2"></i>
                                {{ s.name }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Projects & Links -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white border-2 border-slate-100 rounded-2xl p-4 hover:border-primary-100 transition-colors">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Repositories</span>
                            {% if candidate.github_profiles %}
                                {% for gh in candidate.github_profiles %}
                                <a href="{{ gh.url }}" target="_blank" class="text-xs font-bold text-slate-800 hover:text-primary-600 transition-colors flex items-center mb-1 truncate">
                                    <i class="fab fa-github mr-2"></i>Link {{ loop.index }}
                                </a>
                                {% endfor %}
                            {% else %}
                            <span class="text-xs text-slate-400 font-medium italic">Not mentioned</span>
                            {% endif %}
                        </div>
                        <div class="bg-white border-2 border-slate-100 rounded-2xl p-4 hover:border-primary-100 transition-colors">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">Professional</span>
                            {% if candidate.linkedin_profile %}
                            <a href="{{ candidate.linkedin_profile }}" target="_blank" class="text-xs font-bold text-slate-800 hover:text-primary-600 transition-colors flex items-center truncate">
                                <i class="fab fa-linkedin mr-2 text-[#0077B5]"></i>LinkedIn Profile
                            </a>
                            {% else %}
                            <span class="text-xs text-slate-400 font-medium italic">No profile detected</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Card Footer Actions -->
                <div class="bg-slate-50 p-6 flex gap-4 border-t border-slate-100">
                    <button onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'congratulations', this)" 
                        class="flex-1 inline-flex items-center justify-center px-6 py-4 bg-green-600 text-white rounded-2xl font-black hover:bg-green-700 transition-all shadow-lg active:scale-95">
                        <i class="fas fa-paper-plane mr-2"></i>Congratulate
                    </button>
                    <button onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'rejection', this)" 
                            class="inline-flex items-center justify-center px-6 py-4 bg-white border-2 border-red-100 text-red-600 rounded-2xl font-black hover:bg-red-50 transition-all active:scale-95">
                        <i class="fas fa-times mr-2"></i>Reject
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Not Selected Candidates -->
    {% if not_selected %}
    <div class="mt-20 animate-fade-in" style="animation-delay: 0.2s">
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 border-t border-slate-200 pt-16">
            <div class="flex items-center space-x-4">
                <div class="w-2 h-10 bg-red-400 rounded-full"></div>
                <div>
                    <h2 class="text-3xl font-black text-slate-900">Rejected Applications</h2>
                    <p class="text-slate-500 font-medium">Candidates that didn't meet the target requirement</p>
                </div>
            </div>
            <button onclick="sendAllRejections()" class="inline-flex items-center px-6 py-3 bg-red-50 text-red-700 rounded-2xl font-black hover:bg-red-100 transition-all group active:scale-95">
                <i class="fas fa-trash-alt mr-2 group-hover:shake"></i>
                Bulk Rejection Emails
            </button>
        </div>

        <div class="grid lg:grid-cols-2 gap-8 opacity-70 hover:opacity-100 transition-opacity">
            {% for candidate in not_selected %}
            <div class="bg-white rounded-3xl border border-red-100 shadow-sm transition-all group not-selected-card overflow-hidden">
                <div class="p-8">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-red-50 text-red-400 rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-slash text-lg"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-slate-800">{{ candidate.name }}</h3>
                                <p class="text-xs font-bold text-slate-400 candidate-email-placeholder">{{ candidate.email or 'No email' }}</p>
                            </div>
                        </div>
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center text-center bg-red-600 text-white shadow-lg">
                            <span class="text-xl font-black">{{ candidate.match_score }}%</span>
                        </div>
                    </div>
                    {% if candidate.hr_flags and candidate.hr_flags|length > 0 %}
                    <div class="mt-6 flex items-start gap-3 bg-red-50 rounded-xl p-3 border border-red-100">
                        <i class="fas fa-exclamation-circle text-red-400 mt-1"></i>
                        <p class="text-[11px] font-bold text-red-900 leading-tight">
                            <span class="uppercase opacity-50 block mb-1">Critical Failure Reason:</span>
                            {{ candidate.hr_flags|first }}
                        </p>
                    </div>
                    {% endif %}
                </div>
                <div class="px-8 pb-8">
                    <button onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'rejection', this)" 
                        class="w-full inline-flex items-center justify-center px-6 py-3 bg-slate-900 text-white rounded-2xl font-bold hover:bg-black transition-all active:scale-95">
                        <i class="fas fa-envelope mr-2"></i>Send Final Notice
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if not shortlisted and not not_selected %}
    <div class="text-center py-32 bg-white rounded-[3rem] shadow-xl border-4 border-dashed border-slate-100">
        <div class="w-32 h-32 bg-slate-50 text-slate-300 rounded-full flex items-center justify-center mx-auto mb-10">
            <i class="fas fa-magnifying-glass text-5xl"></i>
        </div>
        <h2 class="text-3xl font-black text-slate-900">Zero matches found</h2>
        <p class="text-slate-500 max-w-lg mx-auto mt-4 text-xl font-medium leading-relaxed">The AI has analyzed all resumes but none crossed the scoring threshold for "{{ company_name }}".</p>
        <div class="mt-12 flex justify-center gap-4">
            <a href="/" class="inline-flex items-center px-10 py-5 bg-primary-600 text-white rounded-3xl font-black hover:bg-primary-700 transition-all shadow-2xl hover:shadow-primary-200 active:scale-95">
                <i class="fas fa-redo mr-3"></i>New Analysis
            </a>
        </div>
    </div>
    {% endif %}
</div>

<script>
function showToast(message, type = 'success') {
    const container = document.querySelector('.toast-container');
    const toast = document.createElement('div');
    toast.className = `flex items-center p-5 text-white rounded-2xl shadow-2xl transition-all duration-500 translate-x-12 opacity-0 font-bold text-sm ${type === 'success' ? 'bg-emerald-600 border-b-4 border-emerald-800' : 'bg-rose-600 border-b-4 border-rose-800'}`;
    toast.innerHTML = `
        <div class="w-6 h-6 rounded-full bg-white/20 mr-4 flex items-center justify-center">
            <i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation'} text-[10px]"></i>
        </div>
        <span>${message}</span>
    `;
    container.appendChild(toast);
    setTimeout(() => { toast.classList.remove('translate-x-12', 'opacity-0'); }, 10);
    setTimeout(() => {
        toast.classList.add('translate-x-12', 'opacity-0');
        setTimeout(() => toast.remove(), 500);
    }, 4500);
}

function sendEmail(email, name, emailType, button) {
    if (!email || email === 'Not provided' || email === 'No email') {
        showToast("No valid email address detected for this candidate", "error");
        return;
    }

    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

    fetch('/send_candidate_email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: email, name: name, email_type: emailType })
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            showToast(`Success! Email dispatched to ${name}`, "success");
            button.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Email Sent';
            button.classList.add('!bg-slate-400', '!border-slate-500');
        } else {
            showToast("System error: " + data.message, "error");
            button.innerHTML = originalHtml;
            button.disabled = false;
        }
    })
    .catch(() => {
        showToast("Network failure. Check your connection.", "error");
        button.innerHTML = originalHtml;
        button.disabled = false;
    });
}

function sendAllCongratulations() {
    const cards = document.querySelectorAll('.shortlisted-card');
    let count = 0;
    cards.forEach(card => {
        const email = card.querySelector('.candidate-email-placeholder').innerText.trim();
        const name = card.querySelector('h3').innerText.trim();
        const btn = card.querySelector('button.bg-green-600');
        if (email && email !== 'No email' && btn && !btn.disabled) {
            sendEmail(email, name, 'congratulations', btn);
            count++;
        }
    });
    if(count === 0) showToast("No eligible candidates left to email", "error");
}

function sendAllRejections() {
    const cards = document.querySelectorAll('.not-selected-card');
    let count = 0;
    cards.forEach(card => {
        const email = card.querySelector('.candidate-email-placeholder').innerText.trim();
        const name = card.querySelector('h3').innerText.trim();
        const btn = card.querySelector('button.bg-slate-900');
        if (email && email !== 'No email' && btn && !btn.disabled) {
            sendEmail(email, name, 'rejection', btn);
            count++;
        }
    });
    if(count === 0) showToast("All rejection emails already sent", "error");
}

function checkAI(filename) {
    window.open(`/ai_check/${encodeURIComponent(filename)}`, '_blank');
}
</script>

</body>
</html>
