<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SmartHire.AI</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
<style>
/* Custom CSS Start */

/* Automatic Width Container */
body {
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
}

/* Navbar - Full Width Automatic */
.navbar {
    width: 100%;
    padding: 1rem 0;
}

.navbar .container {
    width: 100%;
    max-width: calc(100% - 4rem);
    margin: 0 auto;
    padding: 0 2rem;
}

/* Main Container - Automatic Width */
.container.my-4 {
    width: 100%;
    max-width: calc(100% - 4rem);
    margin: 2rem auto !important;
    padding: 0 2rem;
}

.score-badge {
    font-size: 1.2rem;
    font-weight: bold;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
}

/* Score colors */
.score-excellent { background-color: #198754; color: white; }
.score-good { background-color: #0dcaf0; color: white; }
.score-average { background-color: #ffc107; color: black; }
.score-poor { background-color: #dc3545; color: white; }

/* Candidate card hover effect */
.candidate-card {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
}

.candidate-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Warning section gradient background */
.ai-warning {
    background: linear-gradient(45deg, #fff3cd, #f8d7da);
    border: 1px solid #ffeaa7;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
}

/* HR Flags Alert Box */
.hr-flags-alert {
    background: linear-gradient(135deg, #fff3cd 0%, #ffe5b4 100%);
    border: 2px solid #ffc107;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
}

.hr-flags-alert .alert-heading {
    color: #856404;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.hr-flags-alert ul {
    margin-bottom: 0;
    padding-left: 1.5rem;
}

.hr-flags-alert li {
    color: #856404;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

/* âœ… NEW: HR Requirement Skills Highlighting */
.hr-skill-highlight {
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
    padding: 0.4rem 0.8rem;
    border-radius: 0.5rem;
    border: 2px solid #28a745;
    box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2);
    font-weight: 600;
    display: inline-block;
    margin: 0.2rem 0;
}

.hr-skill-highlight i {
    font-size: 1.1rem;
}

.hr-skill-highlight span {
    color: #155724;
}

/* Header section gradient and styling */
.section-header {
    background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
}

/* Stats card styling */
.stats-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    transition: transform 0.2s;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Button minimal width */
.email-btn {
    min-width: 120px;
}

/* Toast container positioning */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
}

/* Responsive Grid for Cards */
.row {
    width: 100%;
}

/* Responsive Design - Automatic Adjustments */
@media (max-width: 768px) {
    .navbar .container {
        max-width: calc(100% - 2rem);
        padding: 0 1rem;
    }
    
    .container.my-4 {
        max-width: calc(100% - 2rem);
        padding: 0 1rem;
    }
    
    .section-header {
        padding: 1rem;
    }
    
    .section-header .d-flex {
        flex-direction: column;
        gap: 1rem;
    }
    
    .stats-card {
        padding: 1rem;
    }
    
    .stats-card h3 {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .navbar .container {
        max-width: calc(100% - 1rem);
        padding: 0 0.5rem;
    }
    
    .container.my-4 {
        max-width: calc(100% - 1rem);
        padding: 0 0.5rem;
    }
    
    .section-header {
        padding: 0.75rem;
    }
    
    .email-btn {
        min-width: 100px;
        font-size: 0.875rem;
    }
    
    .score-badge {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
    }
}

/* Large screens - better spacing */
@media (min-width: 1400px) {
    .navbar .container,
    .container.my-4 {
        max-width: calc(100% - 8rem);
        padding: 0 4rem;
    }
}

/* Ultra wide screens */
@media (min-width: 1920px) {
    .navbar .container,
    .container.my-4 {
        max-width: calc(100% - 12rem);
        padding: 0 6rem;
    }
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary border-bottom">
    <div class="container">
        <a class="navbar-brand" href="/">
            <i class="fas fa-brain me-2"></i>SmartHire.AI
        </a>
        <div class="navbar-nav ms-auto">
            <a class="nav-link" href="/">
                <i class="fas fa-arrow-left me-2"></i>New Analysis
            </a>
        </div>
    </div>
</nav>

<div class="toast-container"></div>

<div class="container my-4">
    <div class="section-header text-center">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div></div>
            <div class="text-center">
                <h1><i class="fas fa-chart-bar me-3"></i>Resume Analysis Results</h1>
                <p class="lead mb-0">{{ company_name }} | Analyzed by {{ hr_name }}</p>
            </div>
            <div class="d-flex flex-column gap-2">
                {% if shortlisted or not_selected %}
                <a href="{{ url_for('download_report', company_name=company_name) }}" class="btn btn-success btn-lg">
                    <i class="fas fa-download me-2"></i>Download Report
                </a>
                <a href="{{ url_for('download_all_selected', company_name=company_name) }}" class="btn btn-success btn-lg">
                    <i class="fas fa-check-circle me-2"></i>Select Candidates
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="fas fa-file-alt fa-2x text-primary mb-2"></i>
                <h3>{{ total_processed }}</h3>
                <p class="mb-0">Total Processed</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="fas fa-star fa-2x text-success mb-2"></i>
                <h3>{{ shortlisted|length }}</h3>
                <p class="mb-0">Shortlisted</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                <h3>{{ not_selected|length }}</h3>
                <p class="mb-0">Not Selected</p>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <i class="fas fa-robot fa-2x text-warning mb-2"></i>
                <h3>{{ (shortlisted + not_selected)|selectattr('is_ai_generated')|list|length }}</h3>
                <p class="mb-0">AI Detected</p>
            </div>
        </div>
    </div>

    <div class="alert alert-info mb-5">
        <h6><i class="fas fa-info-circle me-2"></i>Filter Score Explanation</h6>
        <p class="mb-0">
            <strong>Filter Score:</strong> The percentage score indicates how well a candidate's skills and experience match the job requirements.
            <span class="badge score-excellent ms-2">75%+ = Shortlisted</span>
            <span class="badge score-poor ms-2">&lt;75% = Not Selected</span>
        </p>
    </div>

    {% if shortlisted %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-success mb-0">
                <i class="fas fa-check-circle me-2"></i>Shortlisted Candidates ({{ shortlisted|length }})
            </h2>
            <button class="btn btn-outline-success" onclick="sendAllCongratulations()">
                <i class="fas fa-envelope me-2"></i>All Congratulations
            </button>
        </div>
        <div class="row">
            {% for candidate in shortlisted %}
            <div class="col-lg-6 mb-4">
                <div class="card candidate-card h-100 shortlisted-card">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="fas fa-user me-2"></i>{{ candidate.name }}
                            </h5>
                            <small class="text-muted">{{ candidate.resume_filename }}</small>
                            <div class="mt-3">
                                <small class="text-muted">Skills Checklist</small>
                                <ul class="list-inline mt-2">
                                    {% for s in candidate.skills %}
                                    <li class="list-inline-item me-3 {% if s.is_hr_requirement %}hr-skill-highlight{% endif %}">
                                        <i class="fas {{ 'fa-check-circle text-success' if s.match else 'fa-times-circle text-danger' }}"></i>
                                        <span class="ms-1">{{ s.name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% if candidate.match_reasons %}
                            <div class="mt-2">
                                <small class="text-muted">Selected because:</small>
                                {% for reason in candidate.match_reasons %}
                                <span class="badge bg-light text-dark me-1">{{ reason }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            {% if candidate.missing_skills %}
                            <div class="mt-2">
                                <small class="text-muted">Missing skills:</small>
                                {% for miss in candidate.missing_skills %}
                                <span class="badge bg-danger text-white me-1">{{ miss }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <span class="badge score-excellent score-badge">{{ candidate.match_score }}%</span>
                            {% if candidate.is_ai_generated %}
                            <div class="mt-1">
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-robot me-1"></i>AI Detected
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- HR FLAGS SECTION -->
                        {% if candidate.hr_flags and candidate.hr_flags|length > 0 %}
                        <div class="hr-flags-alert" role="alert">
                            <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>HR Requirement Alerts:</h6>
                            <ul>
                                {% for flag in candidate.hr_flags %}
                                <li>{{ flag }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-envelope me-2" style="color: #D44638;"></i>Email</small>
                                <p class="mb-1 candidate-email-placeholder">{{ candidate.email or 'Not provided' }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-phone me-2" style="color: #28a745;"></i>Phone</small>
                                <p class="mb-1">{{ candidate.phone or 'Not provided' }}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-bullseye me-2" style="color: #6f42c1;"></i>Target Role</small>
                            <p class="mb-1">
                                <span class="badge bg-primary">{{ candidate.target_role }}</span>
                            </p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-business-time me-2" style="color: #fd7e14;"></i>Experience</small>
                                <p class="mb-1">{{ candidate.experience }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-graduation-cap me-2" style="color: #800000;"></i>Education</small>
                                <p class="mb-1">{{ candidate.education.title() if candidate.education else 'Not specified' }}</p>
                            </div>
                        </div>
                        {% if candidate.university %}
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-university me-2" style="color: #005A9C;"></i>University/College</small>
                            <p class="mb-1">{{ candidate.university }}</p>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-certificate me-2" style="color: #ffc107;"></i>Certifications & Achievements</small>
                            {% if candidate.certifications_and_achievements %}
                            <ul class="list-unstyled">
                                {% for cert in candidate.certifications_and_achievements %}
                                <li>
                                    <i class="fas fa-award me-1 text-success"></i>
                                    {{ cert }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fab fa-github me-1 text-dark"></i> GitHub</small>
                            {% if candidate.github_profiles %}
                            <ul class="list-unstyled mb-1">
                                {% for gh in candidate.github_profiles %}
                                <li>
                                    <a href="{{ gh.url }}" target="_blank">{{ gh.url }}</a>
                                    <small class="text-muted">({{ gh.source }})</small>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fab fa-linkedin me-1 text-primary"></i> LinkedIn</small>
                            {% if candidate.linkedin_profile %}
                            <p class="mb-1">
                                <a href="{{ candidate.linkedin_profile }}" target="_blank">{{ candidate.linkedin_profile }}</a>
                            </p>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-user-tie me-2" style="color: #2F4F4F;"></i>Internship</small>
                                <p class="mb-1">{{ 'Yes' if candidate.has_internship else 'No' }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-laptop-code me-2" style="color: #0dcaf0;"></i>Hackathons</small>
                                <p class="mb-1">{{ 'Yes' if candidate.has_hackathon else 'No' }}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-tasks me-2" style="color: #e83e8c;"></i>Projects</small>
                            {% if candidate.projects %}
                            <ul class="list-unstyled">
                                {% for project in candidate.projects %}
                                <li>
                                    <i class="fas fa-code me-1 text-info"></i>
                                    {{ project }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        {% if candidate.is_ai_generated %}
                        <div class="alert ai-warning py-2 mb-3">
                            <small>
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                This resume may contain AI-generated content. Review carefully.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <button class="btn btn-success email-btn" 
                                onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'congratulations', this)">
                                <i class="fas fa-envelope me-1"></i>Congratulate
                            </button>
                            <button class="btn btn-outline-danger email-btn" 
                                onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'rejection', this)">
                                <i class="fas fa-envelope me-1"></i>Send Rejection
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                onclick="checkAI('{{ candidate.resume_filename }}')">
                                <i class="fas fa-search me-1"></i>AI Check
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if not_selected %}
    <div class="mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="text-danger mb-0">
                <i class="fas fa-times-circle me-2"></i>Not Selected Candidates ({{ not_selected|length }})
            </h2>
            <button class="btn btn-outline-danger" onclick="sendAllRejections()">
                <i class="fas fa-envelope me-2"></i>All Rejection
            </button>
        </div>
        <div class="row">
            {% for candidate in not_selected %}
            <div class="col-lg-6 mb-4">
                <div class="card candidate-card h-100 not-selected-card">
                    <div class="card-header d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">
                                <i class="fas fa-user me-2"></i>{{ candidate.name }}
                            </h5>
                            <small class="text-muted">{{ candidate.resume_filename }}</small>
                            <div class="mt-3">
                                <small class="text-muted">Skills Checklist</small>
                                <ul class="list-inline mt-2">
                                    {% for s in candidate.skills %}
                                    <li class="list-inline-item me-3 {% if s.is_hr_requirement %}hr-skill-highlight{% endif %}">
                                        <i class="fas {{ 'fa-check-circle text-success' if s.match else 'fa-times-circle text-danger' }}"></i>
                                        <span class="ms-1">{{ s.name }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% if candidate.missing_skills %}
                            <div class="mt-2">
                                <small class="text-muted">Missing skills:</small>
                                {% for miss in candidate.missing_skills %}
                                <span class="badge bg-danger text-white me-1">{{ miss }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <span class="badge score-poor score-badge">{{ candidate.match_score }}%</span>
                            {% if candidate.is_ai_generated %}
                            <div class="mt-1">
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-robot me-1"></i>AI Detected
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- HR FLAGS SECTION -->
                        {% if candidate.hr_flags and candidate.hr_flags|length > 0 %}
                        <div class="hr-flags-alert" role="alert">
                            <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>HR Requirement Alerts:</h6>
                            <ul>
                                {% for flag in candidate.hr_flags %}
                                <li>{{ flag }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-envelope me-2" style="color: #D44638;"></i>Email</small>
                                <p class="mb-1 candidate-email-placeholder">{{ candidate.email or 'Not provided' }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-phone me-2" style="color: #28a745;"></i>Phone</small>
                                <p class="mb-1">{{ candidate.phone or 'Not provided' }}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-bullseye me-2" style="color: #6f42c1;"></i>Target Role</small>
                            <p class="mb-1">
                                <span class="badge bg-primary">{{ candidate.target_role }}</span>
                            </p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-business-time me-2" style="color: #fd7e14;"></i>Experience</small>
                                <p class="mb-1">{{ candidate.experience }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-graduation-cap me-2" style="color: #800000;"></i>Education</small>
                                <p class="mb-1">{{ candidate.education.title() if candidate.education else 'Not specified' }}</p>
                            </div>
                        </div>
                        {% if candidate.university %}
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-university me-2" style="color: #005A9C;"></i>University/College</small>
                            <p class="mb-1">{{ candidate.university }}</p>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-certificate me-2" style="color: #ffc107;"></i>Certifications & Achievements</small>
                            {% if candidate.certifications_and_achievements %}
                            <ul class="list-unstyled">
                                {% for cert in candidate.certifications_and_achievements %}
                                <li>
                                    <i class="fas fa-award me-1 text-success"></i>
                                    {{ cert }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fab fa-github me-1 text-dark"></i> GitHub</small>
                            {% if candidate.github_profiles %}
                            <ul class="list-unstyled mb-1">
                                {% for gh in candidate.github_profiles %}
                                <li>
                                    <a href="{{ gh.url }}" target="_blank">{{ gh.url }}</a>
                                    <small class="text-muted">({{ gh.source }})</small>
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fab fa-linkedin me-1 text-primary"></i> LinkedIn</small>
                            {% if candidate.linkedin_profile %}
                            <p class="mb-1">
                                <a href="{{ candidate.linkedin_profile }}" target="_blank">{{ candidate.linkedin_profile }}</a>
                            </p>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        <div class="row mb-3">
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-user-tie me-2" style="color: #2F4F4F;"></i>Internship</small>
                                <p class="mb-1">{{ 'Yes' if candidate.has_internship else 'No' }}</p>
                            </div>
                            <div class="col-sm-6">
                                <small class="text-muted"><i class="fas fa-laptop-code me-2" style="color: #0dcaf0;"></i>Hackathons</small>
                                <p class="mb-1">{{ 'Yes' if candidate.has_hackathon else 'No' }}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <small class="text-muted"><i class="fas fa-tasks me-2" style="color: #e83e8c;"></i>Projects</small>
                            {% if candidate.projects %}
                            <ul class="list-unstyled">
                                {% for project in candidate.projects %}
                                <li>
                                    <i class="fas fa-code me-1 text-info"></i>
                                    {{ project }}
                                </li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p class="mb-1">Not mentioned</p>
                            {% endif %}
                        </div>
                        {% if candidate.is_ai_generated %}
                        <div class="alert ai-warning py-2 mb-3">
                            <small>
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                This resume may contain AI-generated content. Review carefully.
                            </small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="d-flex gap-2">
                            <button class="btn btn-danger email-btn" 
                                onclick="sendEmail('{{ candidate.email }}', '{{ candidate.name }}', 'rejection', this)">
                                <i class="fas fa-envelope me-1"></i>Send Rejection
                            </button>
                            <button class="btn btn-outline-info btn-sm" 
                                onclick="checkAI('{{ candidate.resume_filename }}')">
                                <i class="fas fa-search me-1"></i>AI Check
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ðŸ“§ Central Email Sending Function
function sendEmail(email, name, type, button) {
    if (!email || email === 'Not provided') {
        showToast('No email address available for this candidate', 'warning');
        return;
    }

    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';

    fetch('/send_email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email, name: name, type: type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let msg = '';
            if (type === 'congratulations') {
                msg = `Congratulatory email sent to ${name}`;
            } else if (type === 'rejection') {
                msg = `Rejection email sent to ${name}`;
            }
            showToast(msg, 'success');
            button.innerHTML = '<i class="fas fa-check me-1"></i>Sent';
            button.classList.remove('btn-primary', 'btn-danger', 'btn-outline-danger', 'btn-outline-success');
            if (type === 'congratulations') {
                button.classList.add('btn-success');
            } else {
                button.classList.add('btn-danger');
            }
        } else {
            showToast(`Failed to send email: ${data.message}`, 'danger');
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending email', 'danger');
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// ðŸ“§ Bulk Email Functions
function sendAllRejections() {
    const notSelectedCards = document.querySelectorAll('.not-selected-card');
    const emails = [];
    notSelectedCards.forEach(card => {
        const emailElement = card.querySelector('.candidate-email-placeholder');
        if (emailElement) {
            const email = emailElement.textContent.trim();
            if (email && email !== 'Not provided') {
                emails.push(email);
            }
        }
    });

    if (emails.length === 0) {
        showToast('No valid email addresses found to send rejections.', 'warning');
        return;
    }

    const button = document.querySelector('button[onclick="sendAllRejections()"]');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending All...';

    fetch('/send_all_rejections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emails: emails })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Rejection emails sent successfully to ${data.sent_count} candidates!`, 'success');
            button.innerHTML = '<i class="fas fa-check me-1"></i>All Sent';
        } else {
            showToast(`Failed to send all rejection emails: ${data.message}`, 'danger');
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending all rejection emails', 'danger');
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function sendAllCongratulations() {
    const shortlistedCards = document.querySelectorAll('.shortlisted-card');
    const emails = [];
    shortlistedCards.forEach(card => {
        const emailElement = card.querySelector('.candidate-email-placeholder');
        if (emailElement) {
            const email = emailElement.textContent.trim();
            if (email && email !== 'Not provided') {
                emails.push(email);
            }
        }
    });

    if (emails.length === 0) {
        showToast('No valid email addresses found to send congratulations.', 'warning');
        return;
    }

    const button = document.querySelector('button[onclick="sendAllCongratulations()"]');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending All...';

    fetch('/send_all_congratulations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ emails: emails })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Congratulatory emails sent successfully to ${data.sent_count} candidates!`, 'success');
            button.innerHTML = '<i class="fas fa-check me-1"></i>All Sent';
        } else {
            showToast(`Failed to send all congratulatory emails: ${data.message}`, 'danger');
            button.disabled = false;
            button.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending all congratulatory emails', 'danger');
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// AI Check function
function checkAI(filename) {
    window.open(`/ai_check/${encodeURIComponent(filename)}`, '_blank');
}

// ðŸ”” Toast notification helper function
function showToast(message, type) {
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) return;

    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div class="toast align-items-center text-bg-${type} border-0" role="alert" id="${toastId}">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
</body>
</html>
